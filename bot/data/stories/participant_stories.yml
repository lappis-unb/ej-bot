version: "2.0"

stories:

  - story: participant join conversation on webchat
    steps:
      - intent: url
      - slot_was_set:
        - url
      - action: utter_introduce_ej
      - action: action_get_conversation_info
      - slot_was_set:
        - conversation_id
      - action: utter_show_topic_of_discussion
      - action: action_setup_conversation
      - checkpoint: starts_voting

  - story: participant join conversation on telegram
  # When using a link with a payload user send to bot a message
  # start [payload]. We use it to set conversation_id
    steps:
      - intent: start_with_conversation_id
      - slot_was_set:
        - conversation_id
      - action: action_set_channel_info
      - slot_was_set:
        - current_channel_info: 'telegram'
      - action: action_get_conversation_info
      - action: utter_introduce_ej
      - action: utter_show_topic_of_discussion
      - checkpoint: starts_voting
    
  - story: participant join conversation on whatsapp
  # When using a link with a payload user send to bot a message
  # start [payload]. We use it to set conversation_id
    steps:
      - intent: start_with_conversation_id
      - slot_was_set:
        - conversation_id
      - action: action_set_channel_info
      - slot_was_set:
        - current_channel_info: 'twilio'
      - action: action_get_conversation_info
      - action: utter_introduce_ej
      - action: utter_show_topic_of_discussion
      - checkpoint: starts_voting
      # It REALLY needed to rewrite the role story for whatsapp tests

  - story: participant provides valid phone number
    steps:
      - action: utter_send_phone_number
      - intent: phone_number
        entities:
          - regex_phone_number
      - slot_was_set:
        - regex_phone_number
      - checkpoint: starts_voting

  - story: participant joins a invalid conversation
    steps:
      - checkpoint: starts_voting
      - slot_was_set:
        - conversation_id: null
      - action: utter_advise_participant_to_join_again
      - action: action_restart

  - story: participant provides invalid phone number
    steps:
      - action: utter_send_phone_number
      - intent: phone_number
      - slot_was_set:
        - regex_phone_number: null
      - action: utter_invalid_phone_number
      - action: utter_ask_phone_number
      - intent: phone_number
        entities:
          - regex_phone_number
      - action: utter_got_phone_number
      - checkpoint: starts_voting

  - story: participant dont want to inform phone number
    steps:
      - action: utter_ask_phone_number_again
      - intent: disagree
      - action: utter_user_want_anonymous
      - checkpoint: starts_voting

  - story: starts voting form
    steps:
      - checkpoint: starts_voting
      - slot_was_set:
        - conversation_id
      - action: action_setup_conversation
      - action: vote_form
      - active_loop: vote_form

  - story: Ask phone number in the middle of voting
    steps:
      - intent: phone_number
        entities:
          - regex_phone_number
      - slot_was_set:
        - regex_phone_number
      - action: utter_got_phone_number
      - checkpoint: starts_voting

  - story: Goodbye happy path
    steps:
      - action: utter_thanks_participation
      - action: utter_next_conversation
      - action: utter_finish
      - action: action_session_start
